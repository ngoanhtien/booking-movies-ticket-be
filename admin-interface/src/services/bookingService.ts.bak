import axiosInstance from '../utils/axios';
import { ApiResponse, MovieShowtimesResponse, ShowtimeDetail, BranchWithShowtimes } from '../types/showtime';

// S·ª≠ d·ª•ng ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi thay v√¨ URL tuy·ªát ƒë·ªëi ƒë·ªÉ proxy ho·∫°t ƒë·ªông
const API_URL = ''; // T∆∞∆°ng ƒë·ªëi v·ªõi baseURL c·ªßa axios

// ƒê·ªãnh nghƒ©a c√°c interface d·ª±a tr√™n API backend
export interface Showtime {
  id: string;
  time: string;
  roomName: string;
  availableSeats: number;
  price: number;
  movieId: number;
  movieName: string;
  roomId: number;
  scheduleId: number;
}

export enum SeatStatus {
  Available = 'AVAILABLE',
  Booked = 'BOOKED',
  Selected = 'SELECTED',
  Unavailable = 'UNAVAILABLE',
}

export interface Seat {
  id: string;
  row: string;
  number: number;
  status: SeatStatus;
  price: number;
  type?: 'REGULAR' | 'VIP' | 'COUPLE' | 'SWEETBOX' | string;
}

export interface FoodItem {
  id: string;
  name: string;
  description: string;
  price: number;
  imageUrl: string;
}

export interface FoodSelection {
  itemId: string;
  quantity: number;
}

export interface BookingRequest {
  scheduleId: number;
  roomId: number;
  seatIds: string[];
  foodItems: {
    foodId: number;
    quantity: number;
  }[];
  paymentMethod: string;
}

export interface BookingResponse {
  bookingId: number;
  bookingCode: string;
  movie: {
    movieId: number;
    movieName: string;
    format: string;
    date: string;
    startTime: string;
    endTime: string;
  };
  cinema: {
    cinemaName: string;
    roomName: string;
    address: string;
  };
  seats: string[];
  totalAmount: number;
  foodItems: {
    name: string;
    quantity: number;
    price: number;
  }[];
}

// Correct endpoints based on backend controller paths
const BOOKING_ENDPOINTS = {
  CREATE: '/api/v1/payment/sepay-webhook',
  CREATE_ALT: '/api/v1/payment/bookings/create',
  SIMULATE_PAYMENT: '/api/v1/payment/simulate',
  GET_DETAILS: '/api/v1/payment',
  TEST: '/api/v1/payment/test-booking'
};

export const bookingService = {
  // L·∫•y danh s√°ch su·∫•t chi·∫øu theo phim
  getShowtimesByMovie: async (movieId: string): Promise<MovieShowtimesResponse | null> => {
    try {
      // C·∫≠p nh·∫≠t URL endpoint v·ªõi ti·ªÅn t·ªë /api/v1/
      const response = await axiosInstance.get<ApiResponse<MovieShowtimesResponse>>(`/api/v1/showtimes/movies/${movieId}`);
      return response.data?.result || response.data?.data || null;
    } catch (error: unknown) {
      console.error('Error fetching showtimes by movie:', error);
      
      // N·∫øu API l·ªói, tr·∫£ v·ªÅ mock data ƒë·ªÉ ·ª©ng d·ª•ng kh√¥ng b·ªã gi√°n ƒëo·∫°n
      const err = error as any; // Type assertion
      if (err.response?.status === 500) {
        console.log('S·ª≠ d·ª•ng mock data cho showtimes do l·ªói server');
        return {
          movieId: parseInt(movieId),
          movieName: "Movie " + movieId,
          branches: [
            {
              branchId: 1,
              branchName: "CGV Landmark 81",
              address: "Landmark 81, Vinhomes Central Park, Qu·∫≠n B√¨nh Th·∫°nh, TP HCM",
              hotline: "1900 6017",
              imageUrl: "https://www.cgv.vn/media/site/cache/3/980x415/top_banner/2023/11/cgv-imax-with-laser.jpg",
              showtimes: [
                {
                  scheduleId: 101,
                  scheduleTime: "10:00",
                  roomId: 1,
                  roomName: "Room 1",
                  roomType: "2D",
                  status: "AVAILABLE",
                  date: new Date().toISOString().split('T')[0]
                },
                {
                  scheduleId: 102,
                  scheduleTime: "13:30",
                  roomId: 2,
                  roomName: "Room 2",
                  roomType: "3D",
                  status: "AVAILABLE",
                  date: new Date().toISOString().split('T')[0]
                }
              ]
            },
            {
              branchId: 2,
              branchName: "CGV Aeon Mall T√¢n Ph√∫",
              address: "30 B·ªù Bao T√¢n Th·∫Øng, S∆°n K·ª≥, Qu·∫≠n T√¢n Ph√∫, TP HCM",
              hotline: "1900 6017",
              imageUrl: "https://www.cgv.vn/media/site/cache/3/980x415/top_banner/2023/11/cgv-screenx.jpg",
              showtimes: [
                {
                  scheduleId: 201,
                  scheduleTime: "09:30",
                  roomId: 3,
                  roomName: "Room 3",
                  roomType: "2D",
                  status: "AVAILABLE",
                  date: new Date().toISOString().split('T')[0]
                },
                {
                  scheduleId: 202,
                  scheduleTime: "12:45",
                  roomId: 4,
                  roomName: "Room IMAX",
                  roomType: "IMAX",
                  status: "AVAILABLE",
                  date: new Date().toISOString().split('T')[0]
                },
                {
                  scheduleId: 203,
                  scheduleTime: "15:30",
                  roomId: 5,
                  roomName: "Room 5",
                  roomType: "2D",
                  status: "AVAILABLE",
                  date: new Date().toISOString().split('T')[0]
                }
              ]
            },
            {
              branchId: 3,
              branchName: "CGV S∆∞ V·∫°n H·∫°nh",
              address: "19 Nguy·ªÖn VƒÉn C·ª´, ph∆∞·ªùng 4, Qu·∫≠n 5, TP HCM", 
              hotline: "1900 6017",
              imageUrl: "https://www.cgv.vn/media/site/cache/3/980x415/top_banner/2023/12/4dx-banner-cgv.jpg",
              showtimes: [
                {
                  scheduleId: 301,
                  scheduleTime: "11:15",
                  roomId: 6,
                  roomName: "Room 6",
                  roomType: "2D",
                  status: "AVAILABLE",
                  date: new Date().toISOString().split('T')[0]
                },
                {
                  scheduleId: 302,
                  scheduleTime: "14:30",
                  roomId: 7,
                  roomName: "Room 7 (4DX)",
                  roomType: "4DX",
                  status: "AVAILABLE",
                  date: new Date().toISOString().split('T')[0]
                },
                {
                  scheduleId: 303,
                  scheduleTime: "17:30",
                  roomId: 8,
                  roomName: "Room 8",
                  roomType: "2D",
                  status: "AVAILABLE",
                  date: new Date().toISOString().split('T')[0]
                }
              ]
            },
            {
              branchId: 4,
              branchName: "Beta Cinemas Th·ªß ƒê·ª©c",
              address: "216 V√µ VƒÉn Ng√¢n, Ph∆∞·ªùng B√¨nh Th·ªç, Qu·∫≠n Th·ªß ƒê·ª©c, TP HCM",
              hotline: "1900 2099",
              imageUrl: "https://betacinemas.vn/Assets/Images/beta-thu-duc.png",
              showtimes: [
                {
                  scheduleId: 401,
                  scheduleTime: "10:30",
                  roomId: 9,
                  roomName: "Room A",
                  roomType: "2D",
                  status: "AVAILABLE",
                  date: new Date().toISOString().split('T')[0]
                },
                {
                  scheduleId: 402,
                  scheduleTime: "13:45",
                  roomId: 10,
                  roomName: "Room B",
                  roomType: "2D",
                  status: "AVAILABLE",
                  date: new Date().toISOString().split('T')[0]
                },
                {
                  scheduleId: 403,
                  scheduleTime: "16:50",
                  roomId: 11,
                  roomName: "Room C (Sweet Box)",
                  roomType: "SWEETBOX",
                  status: "AVAILABLE",
                  date: new Date().toISOString().split('T')[0]
                }
              ]
            },
            {
              branchId: 5,
              branchName: "Lotte Cinema Cantavil",
              address: "Lotte Cinema Cantavil, T·∫ßng 7 Cantavil Premier, Qu·∫≠n 2, TP HCM",
              hotline: "028 3620 9830",
              imageUrl: "https://lottecinemavn.com/LCHS/Image/Thumnail/th00000000.png",
              showtimes: [
                {
                  scheduleId: 501,
                  scheduleTime: "09:15",
                  roomId: 12,
                  roomName: "Cinema 1",
                  roomType: "2D",
                  status: "AVAILABLE",
                  date: new Date().toISOString().split('T')[0]
                },
                {
                  scheduleId: 502,
                  scheduleTime: "12:00",
                  roomId: 13,
                  roomName: "Cinema 2",
                  roomType: "2D",
                  status: "AVAILABLE",
                  date: new Date().toISOString().split('T')[0]
                },
                {
                  scheduleId: 503,
                  scheduleTime: "15:15",
                  roomId: 14,
                  roomName: "Cinema 3 (Lotte Smartbox)",
                  roomType: "SMARTBOX",
                  status: "AVAILABLE",
                  date: new Date().toISOString().split('T')[0]
                },
                {
                  scheduleId: 504,
                  scheduleTime: "18:30",
                  roomId: 15,
                  roomName: "Cinema 4",
                  roomType: "2D",
                  status: "AVAILABLE",
                  date: new Date().toISOString().split('T')[0]
                }
              ]
            }
          ]
        };
      }
      
      throw error;
    }
  },

  // L·∫•y danh s√°ch su·∫•t chi·∫øu theo phim V√Ä R·∫†P
  getShowtimesByMovieAndCinema: async (movieId: string, cinemaId: string) => {
    const today = new Date().toISOString().split('T')[0];
    try {
      const response = await axiosInstance.get(`${API_URL}/api/v1/showtime/${movieId}/filter`, {
        params: {
          date: today,
          cinemaId: cinemaId
        }
      });
      
      // Handle possible response structures
      if (response.data?.result) {
        return response.data.result;
      } else if (Array.isArray(response.data)) {
        return { data: response.data };
      } else if (response.data?.data) {
        return response.data;
      }
      
      return { data: [] };
    } catch (error) {
      console.error('Error fetching filtered showtimes:', error);
      return { data: [] };
    }
  },

  // L·∫•y danh s√°ch t·∫•t c·∫£ su·∫•t chi·∫øu c√≥ s·∫µn
  getAllShowtimes: async () => {
    const today = new Date().toISOString().split('T')[0];
    try {
      const response = await axiosInstance.get(`${API_URL}/api/v1/showtime/1/by-date`, {
        params: { date: today }
      });
      
      if (response.data?.result) {
        return response.data.result;
      } else if (Array.isArray(response.data)) {
        return { data: response.data };
      } else if (response.data?.data) {
        return response.data;
      }
      return { data: [] };
    } catch (error) {
      console.error('Error fetching all showtimes:', error);
      return { data: [] };
    }
  },

  // L·∫•y s∆° ƒë·ªì gh·∫ø cho m·ªôt su·∫•t chi·∫øu
  getSeatLayout: async (scheduleId: number, roomId: number): Promise<ApiResponse<Seat[]> | null> => {
    try {
      // G·ªçi API t·ªõi endpoint m·ªõi x·ª≠ l√Ω trong ShowtimeController
      // Th√™m timestamp ƒë·ªÉ tr√°nh cache
      const timestamp = new Date().getTime();
      const response = await axiosInstance.get<ApiResponse<Seat[]>>(`/api/v1/showtime/seats/layout`, {
        params: {
          scheduleId,
          roomId,
          _t: timestamp // Th√™m timestamp ƒë·ªÉ tr√°nh cache
        }
      });
      
      if (!response.data) {
        throw new Error('No data received from server');
      }
      
      // Tr·∫£ v·ªÅ d·ªØ li·ªáu t·ª´ server m√† kh√¥ng s·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u
      return response.data;
    } catch (error: unknown) {
      console.error('Error fetching seat layout:', error);
      
      // Kh√¥ng s·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u n·ªØa m√† th√¥ng b√°o l·ªói ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt
      throw error;
    }
  },

  // L·∫•y danh s√°ch m√≥n ƒÉn v√† ƒë·ªì u·ªëng
  getFoodItems: async (): Promise<ApiResponse<FoodItem[]> | null> => {
    try {
      // C·∫≠p nh·∫≠t URL endpoint v·ªõi ti·ªÅn t·ªë /api/v1/
      const response = await axiosInstance.get<ApiResponse<FoodItem[]>>('/api/v1/food-items');
      return response.data || null;
    } catch (error: unknown) {
      console.error('Error fetching food items:', error);
      
      // Tr·∫£ v·ªÅ mock food items n·∫øu API l·ªói
      const err = error as any; // Type assertion
      if (err.response?.status === 500) {
        return {
          status: 'SUCCESS',
          message: 'Successfully retrieved food items',
          data: [
            {
              id: '1',
              name: 'Popcorn (L)',
              price: 79000,
              description: 'Large size popcorn',
              imageUrl: 'https://example.com/popcorn.jpg'
            },
            {
              id: '2',
              name: 'Coca Cola (M)',
              price: 39000,
              description: 'Medium size coca cola',
              imageUrl: 'https://example.com/cola.jpg'
            },
            {
              id: '3',
              name: 'Combo 1 (Popcorn + 2 Cola)',
              price: 149000,
              description: 'Large popcorn with 2 medium cola',
              imageUrl: 'https://example.com/combo.jpg'
            }
          ]
        };
      }
      
      throw error;
    }
  },

  // ƒê·∫∑t v√©
  createBooking: async (bookingData: BookingRequest) => {
    console.log('üîç BOOKING DEBUG: Start createBooking with data:', bookingData);
    console.log('üîç BOOKING DEBUG: Using endpoint:', BOOKING_ENDPOINTS.CREATE);
    
    // S·ª≠ d·ª•ng fetch tr·ª±c ti·∫øp ƒë·ªÉ debug d·ªÖ d√†ng h∆°n
    try {
      const token = localStorage.getItem('token');
      if (!token) {
        console.error('üîç BOOKING DEBUG: No authentication token found!');
        throw new Error('No authentication token found');
      }
      
      console.log('üîç BOOKING DEBUG: Sending POST request to:', BOOKING_ENDPOINTS.CREATE);
      
      const response = await fetch(BOOKING_ENDPOINTS.CREATE, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(bookingData)
      });
      
      console.log('üîç BOOKING DEBUG: Response status:', response.status);
      console.log('üîç BOOKING DEBUG: Response status text:', response.statusText);
      
      // Hi·ªÉn th·ªã headers m·ªôt c√°ch an to√†n h∆°n
      const headersObj: Record<string, string> = {};
      response.headers.forEach((value, key) => {
        headersObj[key] = value;
      });
      console.log('üîç BOOKING DEBUG: Response headers:', headersObj);
      
      if (!response.ok) {
        console.error('üîç BOOKING DEBUG: API Error', response.status, response.statusText);
        
        let errorText = '';
        try {
          const errorData = await response.json();
          errorText = JSON.stringify(errorData);
          console.error('üîç BOOKING DEBUG: Error details:', errorText);
        } catch (e) {
          errorText = 'Could not parse error response';
          console.error('üîç BOOKING DEBUG: Failed to parse error response');
        }
        
        console.log('üîç BOOKING DEBUG: Trying alternative endpoint:', BOOKING_ENDPOINTS.CREATE_ALT);
        // Proceed with alternative endpoint logic below...
      }
      
      const responseData = await response.json();
      console.log('üîç BOOKING DEBUG: Success response data:', responseData);
      
      // Return the appropriate data structure based on the response
      if (responseData?.result) {
        console.log('üîç BOOKING DEBUG: Returning result:', responseData.result);
        return responseData.result;
      }
      console.log('üîç BOOKING DEBUG: Returning full response data');
      return responseData;
    } catch (error) {
      console.error('üîç BOOKING DEBUG: Initial request failed:', error);
      console.log('üîç BOOKING DEBUG: Trying alternative endpoint:', BOOKING_ENDPOINTS.CREATE_ALT);
      
      try {
        const token = localStorage.getItem('token');
        console.log('üîç BOOKING DEBUG: Sending request to alternative endpoint');
        
        const response = await fetch(BOOKING_ENDPOINTS.CREATE_ALT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(bookingData)
        });
        
        console.log('üîç BOOKING DEBUG: Alternative response status:', response.status);
        
        if (!response.ok) {
          console.error('üîç BOOKING DEBUG: Alternative API error:', response.status, response.statusText);
          throw new Error(`Alternative endpoint failed with status ${response.status}`);
        }
        
        const responseData = await response.json();
        console.log('üîç BOOKING DEBUG: Alternative success response:', responseData);
        
        if (responseData?.result) {
          return responseData.result;
        }
        return responseData;
      } catch (altError) {
        console.error('üîç BOOKING DEBUG: All booking attempts failed:', altError);
        throw new Error('Could not create booking. Please try again.');
      }
    }
  },

  // M√¥ ph·ªèng thanh to√°n (kh√¥ng c·∫ßn t√≠ch h·ª£p c·ªïng thanh to√°n th·∫≠t)
  simulatePayment: async (paymentData: any) => {
    console.log('üîç PAYMENT DEBUG: Start simulatePayment with data:', paymentData);
    console.log('üîç PAYMENT DEBUG: Using endpoint:', BOOKING_ENDPOINTS.SIMULATE_PAYMENT);
    
    try {
      const token = localStorage.getItem('token');
      if (!token) {
        console.error('üîç PAYMENT DEBUG: No authentication token found!');
        throw new Error('No authentication token found');
      }
      
      console.log('üîç PAYMENT DEBUG: Sending POST request to:', BOOKING_ENDPOINTS.SIMULATE_PAYMENT);
      
      const response = await fetch(BOOKING_ENDPOINTS.SIMULATE_PAYMENT, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(paymentData)
      });
      
      console.log('üîç PAYMENT DEBUG: Response status:', response.status);
      console.log('üîç PAYMENT DEBUG: Response status text:', response.statusText);
      
      // Hi·ªÉn th·ªã headers m·ªôt c√°ch an to√†n
      const headersObj: Record<string, string> = {};
      response.headers.forEach((value, key) => {
        headersObj[key] = value;
      });
      console.log('üîç PAYMENT DEBUG: Response headers:', headersObj);
      
      if (!response.ok) {
        console.error('üîç PAYMENT DEBUG: Payment simulation failed with status:', response.status);
        throw new Error(`Payment simulation failed with status ${response.status}`);
      }
      
      const responseData = await response.json();
      console.log('üîç PAYMENT DEBUG: Payment simulation response:', responseData);
      
      if (responseData?.result) {
        return responseData.result;
      }
      return responseData;
    } catch (error) {
      console.error('üîç PAYMENT DEBUG: Payment simulation error:', error);
      throw new Error('Payment simulation failed. Please try again.');
    }
  },

  // L·∫•y th√¥ng tin ƒë·∫∑t v√©
  getBookingDetails: async (bookingId: string | number) => {
    try {
      const response = await axiosInstance.get(`${BOOKING_ENDPOINTS.GET_DETAILS}/${bookingId}`);
      return response.data;
    } catch (error: any) {
      console.error(`Error fetching booking details for ID ${bookingId}:`, error.message);
      throw new Error(`Could not fetch booking details: ${error.message}`);
    }
  },

  // L·∫•y l·ªãch s·ª≠ ƒë·∫∑t v√© c·ªßa ng∆∞·ªùi d√πng
  getUserBookings: async () => {
    const response = await axiosInstance.get(`/user/bookings`);
    return response.data;
  },

  // Test booking flow
  testBookingFlow: async () => {
    try {
      console.log('Testing booking flow...');
      const response = await axiosInstance.get(BOOKING_ENDPOINTS.TEST);
      console.log('Test booking response:', response.data);
      return response.data;
    } catch (error: any) {
      console.error('Error testing booking flow:', error.message);
      throw new Error(`Booking test failed: ${error.message}`);
    }
  }
};

export default bookingService; 